<?php declare(strict_types=1);

use MageHx\MageTemplateUtils\Model\Esc;
use MageHx\MahxCheckout\Block\Address\FieldRenderer;
use MageHx\MahxCheckout\Data\FormField\SelectFieldMeta;

/** @var FieldRenderer $block */
/** @var Esc $esc */
/** @var Closure $classNames */
/** @var SelectFieldMeta $fieldMeta */

$fieldConfig = $block->getFieldConfig();

if (! $fieldConfig) {
    return;
}

$fieldMeta = $fieldConfig->meta;
$wrapperClasses = $block->getWrapperElemExtraClasses();
$isDefaultOptSelected = empty($fieldConfig->value) || ! in_array($fieldConfig->value, array_keys($fieldMeta->options));
$renderSelectedAttribute = fn ($condition) => $condition ? 'selected="selected"' : '';
?>
<div
    class="<?= $classNames([
        'field form-control',
        '_required' => $fieldConfig->required,
        'md-col-span-4 md:col-span-4' => $fieldConfig->meta->getSpanWidth() === 4,
        'md-col-span-3 md:col-span-3' => $fieldConfig->meta->getSpanWidth() === 3,
        'md-col-span-2 md:col-span-2' => $fieldConfig->meta->getSpanWidth() === 2,
        'md-col-span-1 md:col-span-1' => $fieldConfig->meta->getSpanWidth() === 1,
        $wrapperClasses => $wrapperClasses
    ]) ?>"
    <?= $block->getWrapperAdditionalAttributes() ?>
>
    <?= /** @noEscape */ $block->getBeforeInputHtml() ?>
    <label class="label" for="<?= $esc->htmlAttr($fieldConfig->getFieldId()) ?>">
        <span class="<?= $classNames([
                'label-text',
                "after:content-['*'] after:text-red-500 after:ml-1" => $fieldConfig->required
            ]) ?>">
            <?= $esc->html($fieldConfig->label) ?>
        </span>
    </label>
    <div class="control">
        <select
            class="select select-bordered select-sm md:select-md w-full"
            id="<?= $esc->htmlAttr($fieldConfig->getFieldId()) ?>"
            name="<?= $esc->htmlAttr($fieldConfig->name) ?>"
            <?= /** @noEscape */ $block->getInputAdditionalAttributes() ?>
        >
            <option value="" <?= $renderSelectedAttribute($isDefaultOptSelected) ?>>
                <?= $esc->html($fieldMeta->defaultOptionLabel) ?>
            </option>
            <?php foreach ($fieldMeta->options as $value => $label): ?>
                <option
                    value="<?= $esc->htmlAttr($value) ?>"
                    <?= $renderSelectedAttribute($fieldConfig->value === $value) ?>
                >
                    <?= $esc->html($label) ?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>
    <?= /** @noEscape */ $block->getAfterInputHtml() ?>
</div>
