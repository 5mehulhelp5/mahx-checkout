<?php

use MageHx\HtmxActions\ViewModel\HxAttributesRenderer;
use Magento\Framework\View\Element\Template;
use MageHx\MahxCheckout\Enum\CheckoutForm;
use MageHx\MahxCheckout\ViewModel\ShippingAddress;
use MageHx\MahxCheckout\ViewModel\ShippingAddressCards;

/** @var Template $block */
/** @var Closure $eHtml */
/** @var Closure $eHtmlAttr */
/** @var Closure $eUrl */
/** @var string $formKey */
/** @var Closure $viewModelProvider */
/** @var ShippingAddressCards $viewModel */
/** @var ShippingAddress $formModel */
/** @var HxAttributesRenderer $hxAttributesRenderer */

$viewModel = $viewModelProvider(ShippingAddressCards::class);
$hxAttributesRenderer = $viewModelProvider(HxAttributesRenderer::class);
$formModel = $viewModelProvider(ShippingAddress::class);
$addOOBAttribute = $block->getData('add_oob_attribute');
$newAddressFormName = CheckoutForm::NEW_ADDRESS->value;
?>
<div id="new-address-form-container" x-data="NewAddressFormManager">
    <form id="<?= $eHtmlAttr($newAddressFormName) ?>"
        <?= $hxAttributesRenderer->hxBuilder()
            ->post('mahxcheckout/form/saveNewShippingAddress')
            ->target('#shipping-address-cards')
            ->indicator('#shipping-address-cards-loader')
            ->swapOuterHTML()
            ->render(); ?>
    >
        <h2 class="text-xl font-semibold mb-4"><?= $eHtml(__('Add New Address')) ?></h2>
        <?php foreach ($formModel->getAddressFields($newAddressFormName) as $field): ?>
            <?= $formModel->renderField($field) ?>
        <?php endforeach; ?>
        <?= $formKey ?>
        <div class="flex items-center justify-end space-x-4">
            <button
                class="btn btn-ghost" type="button"
                <?= $hxAttributesRenderer->hxBuilder()
                    ->post('mahxcheckout/shipping/getShippingAddressCardsContent')
                    ->target('#shipping-address-cards')
                    ->include('[name=form_key]')
                    ->indicator('#shipping-address-cards-loader')
                    ->swapOuterHTML()
                    ->render(); ?>
            >
                <?= $eHtml(__('Cancel')) ?>
            </button>
            <button class="btn btn-neutral" type="submit">
                <?= $eHtml($viewModel->isNewAddressExists() ? __('Ship Here') : __('Update')) ?>
            </button>
        </div>
    </form>
</div>
